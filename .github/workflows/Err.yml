name: ğŸ› ï¸ Full Repo Auto Fix & Repair

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-fix-${{ github.ref }}
  cancel-in-progress: true

jobs:
  repair:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£ Checkout
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2ï¸âƒ£ Python Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£ Install uv (safe method)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Verify uv
        run: uv --version

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4ï¸âƒ£ Dependency Repair
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Sync dependencies (repair mode)
        run: |
          if [ -f uv.lock ]; then
            uv sync --frozen || uv sync
          else
            uv pip install -r requirements.txt || true
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5ï¸âƒ£ Install Repair Tools
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install tools
        run: |
          uv pip install \
            black \
            isort \
            ruff \
            autoflake \
            pip-audit \
            bandit \
            mypy || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6ï¸âƒ£ Auto-fix Code (Aggressive)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Auto-fix Python code
        run: |
          uv run autoflake \
            --remove-all-unused-imports \
            --remove-unused-variables \
            --recursive \
            --in-place .

          uv run isort .
          uv run black .

          uv run ruff check . \
            --fix \
            --unsafe-fixes \
            --exit-zero

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7ï¸âƒ£ Static Analysis (non-blocking)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Security & type checks
        continue-on-error: true
        run: |
          uv run bandit -r . || true
          uv run mypy . || true
          uv run pip-audit || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8ï¸âƒ£ Lockfile Consistency
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Repair lockfile
        continue-on-error: true
        run: uv lock || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9ï¸âƒ£ Detect Repo Changes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Detect changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ”Ÿ Create Auto-Fix PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Pull Request
        if: env.CHANGED == 'true' && github.actor != 'github-actions[bot]'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "ğŸ› ï¸ Auto-fix: repair entire repo"
          title: "âœ… Automated Full Repo Repair"
          body: |
            ğŸ”§ Repo automatically repaired:

            âœ” Code formatting (Black)
            âœ” Import fixes (isort)
            âœ” Dead code removal (autoflake)
            âœ” Bug fixes (Ruff)
            âœ” Dependency sync & lock repair
            âœ” Security & audit scan

            âš ï¸ Review before merge.
          labels: auto-fix, repair, ci
          branch: repo-auto-repair-${{ github.run_id }}
          delete-branch: true
