name: ðš»Õ°Ò½ ðš¨Åêª®â²›ð›† ðŸš©ð—§Îµá§˜â€Œá´

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  full-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # âœ… Install uv (CI-safe)
      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv

      # âœ… Verify uv (debug safety)
      - name: Verify uv
        run: uv --version

      # Sync deps
      - name: Sync from uv.lock
        run: uv sync --frozen

      # Tools
      - name: Install tools
        run: uv pip install black isort ruff pip-audit

      - name: Format python files
        run: |
          uv run black .
          uv run isort .

      - name: Ruff auto-fix
        run: |
          uv run ruff check . \
            --fix \
            --unsafe-fixes \
            --exit-zero

      - name: Detect changes
        run: |
          uv lock --check || true
          if [ -n "$(git status --porcelain)" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Dependency audit
        continue-on-error: true
        run: uv run pip-audit

      - name: Create Pull Request
        if: env.CHANGED == 'true' && github.actor != 'github-actions[bot]'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "Auto update: full repo auto-fix"
          title: "âœ… Automated repo auto-fix"
          body: |
            âœ” Black formatting
            âœ” Import sorting (isort)
            âœ” Ruff auto-fix
            âœ” uv.lock consistency
          labels: auto-fix, uv, ci
          branch: repo-auto-check-${{ github.run_id }}
          delete-branch: true
